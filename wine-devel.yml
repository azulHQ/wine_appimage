version: 1

script:
  # Remove any previous build cache data
  - rm -rf AppDir appimage-builder-cache/var/cache/apt/archives/*wine* || true
  - mkdir -p appimage-build/prime AppDir/winedata && cp wrapper AppDir
  # Add winetricks
  - wget -q "https://raw.githubusercontent.com/Winetricks/winetricks/master/src/winetricks" -P ./AppDir/bin && chmod +x ./AppDir/bin/winetricks
  # Copy App icon to AppDir/usr/share/icons needed prior to appimage-builder ver 1.x.x
  - mkdir -p AppDir/usr/share/icons ; cp wine.svg AppDir/usr/share/icons
  # Add static appimage runtime
  - cp runtime/runtime-x86_64 appimage-build/prime/runtime-x86_64

AppDir:
  path: ./AppDir

  app_info:
    id: org.winehq.wine
    name: wine
    icon: wine
    version: !ENV ${WINE_VER}
    exec: bin/bash
    exec_args: $APPDIR/wrapper $@

  apt:
    arch: [amd64]
    sources:
      - sourceline: 'deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse'
      - sourceline: 'deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse'
      - sourceline: 'deb http://archive.ubuntu.com/ubuntu/ jammy-backports main restricted universe multiverse'
        key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920D1991BC93C'
      - sourceline: 'deb https://dl.winehq.org/wine-builds/ubuntu/ jammy main'
        key_url: 'https://dl.winehq.org/wine-builds/winehq.key'
      # - sourceline: 'deb http://ppa.launchpad.net/graphics-drivers/ppa/ubuntu/ jammy main'
        # key_url: 'http://keyserver.ubuntu.com/pks/lookup?op=get&search=0xFCAE110B1118213C'
      - sourceline: 'deb https://ppa.launchpadcontent.net/kisak/kisak-mesa/ubuntu jammy main'
        key_url: 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xf63f0f2b90935439'

    include:
      # - wine-staging-i386=8.21~jammy-1
      # - wine-staging-amd64=8.21~jammy-1
      - bash
      - cabextract
      - cups
      - dash
      - perl
      - coreutils
      - mesa-utils
      - mesa-utils-bin
      - vulkan-tools
      - libmspack0

  files:
    exclude:
      - sbin
      - var
      - etc/alternatives
      - etc/apt
      - etc/cron.daily
      - etc/dpkg
      - etc/mysql
      - etc/sane.d
      - etc/sensors.d
      - etc/skel
      - etc/snmp
      - etc/udev
      - etc/gss
      - etc/init.d
      - etc/logrotate.d
      - lib/modprobe.d
      - lib/systemd
      - lib/udev
      - usr/lib/mime
      - usr/lib/sasl2
      - usr/lib/tmpfiles.d
      - usr/sbin
      - usr/share/apps
      - usr/share/man
      - usr/share/doc
      - usr/share/adduser
      - usr/share/apport
      - usr/share/bash-completion
      - usr/share/bug
      - usr/share/debconf
      - usr/share/doc
      - usr/share/doc-base
      - usr/share/dpkg
      - usr/share/glib-2.0
      - usr/share/gst-plugins-base
      - usr/share/hal
      - usr/share/info
      - usr/share/initramfs-tools
      - usr/share/kde4
      - usr/share/libgphoto2
      - usr/share/lintian
      - usr/share/menu
      - usr/share/metainfo
      - usr/share/mesa-demos
      - usr/share/mime
      - usr/share/misc
      - usr/share/mysql-common
      - usr/share/pixmaps
      - usr/share/pkgconfig
      - usr/share/polkit-1
      - usr/share/snmp
      - usr/share/zoneinfo
      - usr/share/zoneinfo-icu
      - usr/share/zsh
      - opt/wine-staging
      - opt/wine-devel/share/man
      - opt/wine-devel/share/applications
      - opt/wine-devel/lib/wine/i386-unix/*.a
      - opt/wine-devel/lib/wine/i386-windows/*.a
      - opt/wine-devel/lib64/wine/x86_64-unix/*.a
      - opt/wine-devel/lib64/wine/x86_64-windows/*.a

  after_bundle:
    # this is executed after the packages and files are added
    - |
     # Patch wrapper script
     sed -i 's|wine-appimage|wine-appimage-devel|' AppDir/wrapper

     # Check for rc builds
     if [ $(wget -qO- https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/main/binary-amd64/ | grep wine-devel | tail -n1 | grep -c ~rc) -gt 0 ]; then
      WINE_VER="$(wget -qO- https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/main/binary-amd64/ | grep wine-devel | sed 's|_| |g;s|~| |2' | awk '{print $5}' | tail -n1)"
     else
      WINE_VER="$(wget -qO- https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/main/binary-amd64/ | grep wine-devel | sed 's|_| |g;s|~| |g' | awk '{print $5}' | tail -n1)"
     fi
     wget -q -c https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/main/binary-i386/wine-devel_${WINE_VER}~jammy-1_i386.deb
     wget -q -c https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/main/binary-i386/wine-devel-i386_${WINE_VER}~jammy-1_i386.deb
     wget -q -c https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/main/binary-amd64/wine-devel_${WINE_VER}~jammy-1_amd64.deb
     wget -q -c https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/main/binary-amd64/wine-devel-amd64_${WINE_VER}~jammy-1_amd64.deb
     dpkg -x "wine-devel_${WINE_VER}~jammy-1_i386.deb" AppDir/
     dpkg -x "wine-devel-i386_${WINE_VER}~jammy-1_i386.deb" AppDir/
     dpkg -x "wine-devel_${WINE_VER}~jammy-1_amd64.deb" AppDir/
     dpkg -x "wine-devel-amd64_${WINE_VER}~jammy-1_amd64.deb" AppDir/
     (cd AppDir/usr/bin; ln -s "../../opt/wine-devel/bin/"* .)

     # Cleanup
     rm -rf AppDir/usr/share/{applications,man,doc}
     rm -rf AppDir/opt/wine-devel/share/{applications,man,doc}
     rm -rf AppDir/opt/wine-devel/lib/wine/i386-unix/*.a
     rm -rf AppDir/opt/wine-devel/lib/wine/i386-windows/*.a
     rm -rf AppDir/opt/wine-devel/lib64/wine/x86_64-unix/*.a
     rm -rf AppDir/opt/wine-devel/lib64/wine/x86_64-windows/*.a

  runtime:
    env:
      APPDIR_LIBC_VERSION: '2.40'

    path_mappings:
    - /opt/wine-devel:$APPDIR/opt/wine-devel

AppImage:
  update-information: gh-releases-zsync|mmtrt|WINE_AppImage|test6|wine-devel*.AppImage.zsync
  #sign-key: None
  arch: x86_64

